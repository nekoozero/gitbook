# 类加载机制

## 定义

`Java`虚拟机把描述类的数据从`Class`文件加载到内存，并对数据进行校验、转换解析和初始化，最终形成可以被虚拟机直接使用的`java`类型，这个过程被称为虚拟机的类加载机制。

## 类加载的时机

一个类型的生命周期（加载到虚拟机内存开始，到卸载出内存为止）：**加载、*验证、准备、解析*、初始化、使用和卸载**七个阶段。

验证、准备、解析又叫做“连接”。

加载、验证、准备、初始化和卸载这五个阶段的顺序是确定的，类型的加载过程必须按照这种顺序按部就班地开始。解析阶段则不一定。

![cbcf6c373529c90ecb292f0b8ccde5e0.jpg](http://www.qxnekoo.cn:8888/images/2020/03/19/cbcf6c373529c90ecb292f0b8ccde5e0.jpg)

有且只有六种情况必须立即对类进行初始化（而加载、验证、准备自然是在此前开始），需要先触发其初始化阶段。

* 遇到`new、getstatic、putstatic或invokestatic`这四条字节码指令时，如果类型没有进行过初始化，则需要先触发其初始化阶段。典型代码场景有：
  * 使用`new`关键字实例化对象的时候。
  * 读取或设置一个类型的静态字段（被`final`修饰、一在编译期把结果放入常量池的静态字段除外）的时候
  * 调用一个类型的静态方法

* 使用`java.lang.reflect`包对类型进行反射调用的时候，如果类型没有被初始化，则需要先触发其初始化。
* 当初始化类的时候，如果发现其父类还没有进行过初始化，则需要先触发其父类的初始化
* 虚拟机启动时，用户需要指定一个要执行的主类，虚拟机会先初始化这个主类。
* 使用`JDK7`新加入的动态语言支持时，需要先触发其初始化
* 一个接口中定义了`JDK8`新加入的默认方法（被`default`关键字修饰的接口方法），如果有这个接口的实现类发生了初始化，那该接口要在其之前被初始化。

## 类加载过程

即加载、验证、准备、解析、初始化这五个阶段所执行的具体操作

### 加载

主要完成三件事

1. 通过一个类的全限定名来获取定义此类的二进制字节流
2. 将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构
3. 在内存中生成一个代表这个类的`java.lang.Class`对象，作为方法区这个类的各个数据访问入口

数组类的类型元素还是靠类加载器来完成加载。

### 验证

验证是连接的第一步，目的是确保`Class`文件的字节流中包含的信息符合虚拟机规范的全部约束要求，是虚拟机自我保护的一项必要措施。

1. 文件格式验证：字节流是否符合`Class`文件格式的规范。这阶段是基于二进制字节流进行的，通过这个阶段的字节流才被允许进入`java`虚拟机内存的方法区中进行存储，所以后面的三个验证阶段全部是基于方法区的存储结构上进行的，不会再直接读取、操作字节流了。
2. 元数据验证：是对字节码描述的信息进行**语义分析**，也就是对类的元数据信息阱行语义校验。比如类是否继承了不允许被继承的类等等……
3. 字节码验证：通过对数据流分析和控制流分析，确定程序语义是否是合法的、符合逻辑的，对类的方法体进行校验分析。
4. 符号引用验证：发生在将符号引用转化为直接引用的时候，这个转化动作将在解析阶段中发生，该类i是否缺少或者被禁止访问它依赖的某些外部类、方法、字段等资源

### 准备

正式为类中定义的变量（即静态变量，被static修饰的变量，不包括实例对象）分配内存并设置类变量初始值的阶段。应当在方法区分配，但在`JDK8`之后，类变量则会随着`Class`对象存放在`Java`堆中

### 解析

### 初始化

