# IO简介

IO 设备一般包括两个部分：设备控制器和设备本身。控制器本身是一块芯片或者一组芯片。它能控制物理设备。能够接受操作系统的指令，例如，从设备中读取数据并完成数据的处理。

实际控制设备的过程是非常复杂而且存在诸多细节的，因此控制器的工作就是为操作系统提供一个更简单（但仍然非常复杂）的接口。也就是屏蔽物理细节。

每种类型的设备控制器是不同的，所以需要不同的软件进行控制。专门与控制器进行信息交流，发出命令处理指令接受响应的软件，称为**设备驱动程序**。每个控制器厂家都应该针对不同的操作系统提供不同的设备驱动程序。

为了使设备驱动程序能够工作，必须把它安装在操作系统中，这样能够使它在内核态中运行，要将设备驱动程序装入操作系统，一般有三个途径。

1. 将内核与设备启动程序重新连接，然后重启系统。-- UNIX
2. 在一个操作系统文件中设置一个入口，通知该文件需要一个设备驱动程序，然后重新启动系统，再重启系统时，操作系统会巡寻找有关的设备启动程序并把它装载。 --Windows
3. 操作系统能够在运行时接受新的设备驱动程序并立刻安装，无需重启操作系统，这种方式少，但是正在普及。热拔插设备，比如 USB 需要动态可装载的设备驱动程序。

每个设备控制器都有少量用于通信的寄存器。要激活控制器，设备驱动程序会从操作系统获取一条指令，然后翻译成对应的值，并写入设备寄存器中，所有设备寄存器的结合构成了 IO 端口空间。

1. 在一些计算机中，设备寄存器会被映射到操作系统的可用地址空间，使它们能够像内存一样完成读写操作。这种计算机，不需要专门的 IO 指令，用户程序可以被硬件阻挡在外，防止其接触这些存储器地址。

2. 在另一些计算机中，设备寄存器被放入一个专门的 IO 端口空间，每个寄存器都有一个端口地址。在这些计算集中，特殊的 IN 和 OUT 指令会在内核态下启动，它能够允许设备驱动程序和寄存器斤进行读写。

第一种方式会限制特殊的 IO 指令但是允许一些地址空间；后者不需要地址空间但是需要特殊的指令，这两种应用都很广泛。

**实现输入和输出的方式有三种:**

- 简单的方式，用户程序会发起系统调用，内核会将其转换为相应驱动程序的程序调用，然后设备驱动程序启动 IO 并循环检查该设备，看该设备是否完成了工作（一般会有一些二进制位用来指示设备仍在忙碌中）。当 IO 调用完成后，设备驱动程序把数据送到指定的地方并返回。然后操作系统会将控制权交给调用者。这种方式称为 忙等待（busy waiting）,这种方式的缺点是要一直占据 CPU，CPU 会一直轮询 IO 设备直到 IO 操作完成。
- 第二种方式时设备驱动程序启动设备并且让该设备在操作完成时发生中断。设备驱动程序在这个时刻返回。操作系统接着在需要时阻塞调用者并安排其他工作进行。当设备驱动程序检测到该设备操作完成时，它发出一个中断通知操作完成。
- 实现 IO 的第三种方式时使用特殊的硬件：**直接存储器访问（Direct Memory Access,DMA）**芯片。它可以控制内存和某些控制器之间的位流，而无需 CPU 的干预。CPU 会对 DMA 芯片进行设置，说明需要传送的字节数，有关的设备和内存地址以及操作方向。当 DMA 芯片完成后，会造成中断。

## 中断简介

中断是非常重要的

![a1486068dfe4049b0c19ffed6dc13447.png](http://www.qxnekoo.cn:8888/images/2020/08/25/a1486068dfe4049b0c19ffed6dc13447.png)

启动设备并发出中断的过程

三步的 IO 过程，第一步，设备驱动程序会通过写入设备寄存器告诉控制器应该做什么。然后，控制器启动设备。当控制器完成读取或写入被告知需要传输的字节后，它会在步骤 2  中使用某些总线像中断控制器发送信号。如果中断控制器准备好接受中断信号（比如正忙于一个优先级较高的中断，则可能不会接收），那么它就会再 CPU 的一个引脚上面声明。这就是步骤 3。在第四步中，中断控制器把该设备的编号放在总线上，这样 CPU 可以读取总线，并且知道哪个设备完成了操作（可能同时有多个设备同时运行）。

一旦 CPU 决定去实施中断后，程序计数器和 PSW 就会被压入当前堆栈中并且 CPU 会切换到内核态。设备编号可以作为内存的一个引用，用来寻找该设备中断处理程序的地址。这部分内存称作中断向量。一旦中断处理程序开始后，他会移除栈中的程序计数器和 PSW 寄存器，并把它们进行保存，然后查询设备的状态。在中断处理程序全部完成后，它会返回到先前用户程序尚未执行的第一条指令。这个过程如下：

![58bdd6604a2f3ed50691360d78b9ffc1.png](http://www.qxnekoo.cn:8888/images/2020/08/25/58bdd6604a2f3ed50691360d78b9ffc1.png)























