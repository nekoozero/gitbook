# HTTP报文内的HTTP信息

> 2020/6/27

## HTTP报文

请求端的 HTTP 报文叫做请求报文，响应端的叫做响应报文。HTTP 报文本身是由多行数据构成的字符串文本。

HTTP 报文大致可分为报文首部和报文主体两块，但并不一定要有报文主体。

## 报文结构

![15932372991.png](http://www.qxnekoo.cn:8888/images/2020/06/27/15932372991.png)

- 请求行

  包含用于请求的方法，请求 URI 和 HTTP 版本

- 状态行

  包含表明响应结果的状态码，原因短语和 HTTP 版本。

- 首部字段

  包含表示请求和响应的各种条件属性的各类首部。一般是 4 种首部，分别是：通用首部、请求首部、响应首部和实体首部。

## 编码提升传输速率

HTTP在传输数据时可以按照数据原貌直接传输，但也可以在传输过程中通过编码提升传输速率（处理大量访问请求，消耗更多 CPU 等资源）。

### 报文主体和实体主体的差异

- 报文（message）

  是 HTTP 通信中的基本单位，由 8 位字节流组成，通过 HTTP 通信传输。

- 实体（entity）

  作为请求或响应的有效载荷数据被传输，其内容由实体首部和实体主体组成。

HTTP 报文的主体用于传输请求或响应的实体主体。

通常，报文主体等于实体主体，只有当传输中进行编码操作时，实体主体的内容发生变化，才导致它和报文主体产生差异。

### 压缩传输的内容编码

HTTP协议中有一种被称为内容编码的功能。

内容编码指明应用在实体内容上的编码格式，并保持实体信息原样压缩。内容编码后的实体由客户端接受并负责解码。

![15932385761.png](http://www.qxnekoo.cn:8888/images/2020/06/27/15932385761.png)

常用的内容编码有以下几种

- gzip(GNU zip)
- compress(UNIX 系统的标准压缩)
- deflate(zlib)
- identity(不进行编码)

### 分割发送的分块传输编码

HTTP 通信过程中，请求的编码实体资源尚未全部传输完成之前，浏览器无法显示请求页面。在传输大容量数据时，通过把数据分割成多块，能够让浏览器逐步显示页面。

这种把实体主体分块的功能称为**分块传输编码**（Chunked Transfer Coding)。

![15932394341.png](http://www.qxnekoo.cn:8888/images/2020/06/27/15932394341.png)

分块传输编码会将实体主体分成多个部分。每一块都会用十六进制来标记块的大小，而实体主体的最后一块会使用“0(CR+LF)”来标记。

使用分块传输编码的实体主体会由接收的客户端负责解码，恢复到编码前的实体主体。

HTTP/1.1 中存在一种称为传输编码（Transfer Coding）的机制，它可以在通信时按某种编码方式传输，但只定义作用于分块传输编码中。

## 发送多种数据的多部分对象集合

我们可以在邮件里写入文字并添加多份附件。这是因为采用了 MIME(Multipurpose Internet Mail Extensions，多用途因特网邮件扩展)机制，它允许邮件处理文本、图片、视频等多个类型不同的数据。

例如，图片等二进制数据以 ASCII 码字符串的方式指明，就是利用 MIME 来描述标记数据类型。而在 MIME 扩展中会使用一种称为**多部份对象集合（Multipart）**的方法，来容纳多份不同类型的数据。

HTTP 协议中也采纳了多部份对象集合，发送的一份报文主体内可含有多类型实体。通常是在图片或文本文件等上传时使用。

多部份对象集合包含的对象如下：

- **multipart/form-data**
- **multipart/byteranges** 
- **multipart/form-data**
- **multipart/byteranges**

在 HTTP 报文中使用多部份对象集合时，需要在首部字段里加上 Content-type。

## 获取部分内容的范围请求

如果下载过程中遇到网络中断的情况，那就必须重头就开始。为了解决上述问题，需要一种可恢复的机制。所谓恢复是指能从之前下载中断处恢复下载。

要实现该功能需要指定下载的实体范围。指定范围发送的请求叫做**范围请求（Range Request）**。

对于一份 10000 字节大小的资源，如果使用范围请求，可以只请求 5001-10000 字节内的资源。

![15932417661.png](http://www.qxnekoo.cn:8888/images/2020/06/27/15932417661.png)

执行范围请求时，会用到**首部字段 Range** 来指定资源的 byte 范围。

指定形式如下：

- 5001-10000字节

  Range: bytes=5001-10000

- 从 5001 字节之后全部的

  Range: bytes=5001

- 从一开始到 3000 字节和 5000~7000 字节的多重范围

  Range: bytes=-3000, 5000-7000

针对范围请求，响应会返回状态码为 206 Partial Content 的响应报文。另外，对于对重范围的范围请求，响应会在首部字段 Content-Type 标明 multipart/byteranges 后返回响应报文。

如果服务端无法响应范围请求，则会返回状态码 200 OK 和完整的实体内容。























